<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Student Dashboard</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css"/>
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap');
    body { font-family: 'Inter', sans-serif; background-color: #F8FAFC; }
    .no-scrollbar::-webkit-scrollbar { display: none; }
    .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
  </style>
</head>
<body class="pb-20">

  <nav class="bg-white shadow-sm sticky top-0 z-50">
    <div class="max-w-7xl mx-auto px-4 py-3 flex flex-col md:flex-row justify-between items-center gap-3">
      <div class="flex items-center gap-2 w-full md:w-auto justify-between">
        <div class="flex items-center gap-2 text-indigo-600">
            <i class="fa-solid fa-graduation-cap text-2xl"></i>
            <span class="font-bold text-lg tracking-tight text-gray-900">ProLearn</span>
        </div>
        <button onclick="logout()" class="md:hidden text-xs bg-red-50 text-red-600 px-3 py-1.5 rounded-full hover:bg-red-100 transition"><i class="fa-solid fa-sign-out-alt"></i></button>
      </div>
      <div class="hidden md:flex items-center gap-4">
        <span class="text-gray-600 text-sm">Welcome, <span id="studentName" class="font-bold text-indigo-600">Student</span></span>
        <button onclick="logout()" class="text-xs bg-red-50 text-red-600 px-4 py-2 rounded-full hover:bg-red-100 transition">Logout</button>
      </div>
    </div>
  </nav>

  <div id="heroSection" class="bg-gray-900 text-white py-8 md:py-12 mb-6 animate__animated animate__fadeIn">
    <div class="max-w-7xl mx-auto px-4 flex flex-col md:flex-row items-center justify-between gap-6">
      <div class="text-center md:text-left w-full">
        <h1 class="text-3xl md:text-4xl font-bold mb-2">Unlock Your Potential</h1>
        <p class="text-gray-300 mb-6 text-sm md:text-base">Master new skills anytime, anywhere.</p>
        <div class="relative w-full md:max-w-md mx-auto md:mx-0">
          <input type="text" id="searchInput" onkeyup="filterCourses()" placeholder="Search courses..." class="w-full px-5 py-3 rounded-full text-gray-900 focus:outline-none focus:ring-2 focus:ring-indigo-500 shadow-lg text-sm">
        </div>
      </div>
    </div>
  </div>

  <div class="max-w-7xl mx-auto px-4">
    <div id="catalog" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-4 md:gap-6 animate__animated animate__fadeInUp"></div>
    <div id="noResults" class="hidden text-center py-10"><h3 class="text-lg font-bold text-gray-700">No courses found</h3></div>

    <div id="learningArea" class="hidden fixed inset-0 z-[100] bg-white flex flex-col animate__animated animate__zoomIn">
      <div class="bg-gray-900 text-white p-4 flex justify-between items-center shrink-0 shadow-md">
        <button onclick="closePlayer()" class="text-gray-300 hover:text-white flex items-center gap-2 transition text-sm font-medium"><i class="fa-solid fa-arrow-left"></i> <span>Back</span></button>
        <h2 id="courseTitle" class="font-bold text-base md:text-lg truncate max-w-[200px] md:max-w-md text-center">Course Title</h2>
        <div class="w-20"></div>
      </div>

      <div class="flex flex-col lg:flex-row flex-1 overflow-hidden h-full">
        <div class="w-full lg:w-3/4 bg-black flex items-center justify-center relative group shrink-0 h-[40vh] lg:h-auto" id="videoStage">
          <div class="text-center p-6"><i class="fa-solid fa-play-circle text-5xl md:text-6xl text-white opacity-50 mb-4"></i><p class="text-gray-400 text-sm">Select content to start.</p></div>
        </div>

        <div class="w-full lg:w-1/4 bg-white flex flex-col h-full border-l border-gray-200 shadow-xl relative z-10">
          <div class="p-3 border-b border-gray-100 bg-gray-50 flex justify-between items-center">
            <h3 class="font-bold text-gray-700 text-sm">Course Content</h3>
            <span class="text-xs text-gray-500 bg-gray-200 px-2 py-1 rounded-full">Menu</span>
          </div>
          <div id="playlist" class="flex-1 overflow-y-auto p-2 space-y-2 pb-20 lg:pb-2"></div>
        </div>
      </div>
    </div>
  </div>

<script>
    const studentId = parseInt(localStorage.getItem("user_id"));
    if (!studentId) { window.location.href = "/"; }
    function logout() { localStorage.clear(); window.location.href = "/"; }
    if(localStorage.getItem("user_name")) document.getElementById("studentName").innerText = localStorage.getItem("user_name");

    let courseData = { videos: [], resources: [], quizzes: [] };

    function getCourseImage(id) {
        return ["https://img.freepik.com/free-vector/laptop-with-program-code-isometric-icon-software-development-programming-applications-dark-neon_39422-971.jpg","https://img.freepik.com/free-vector/gradient-ui-ux-background_23-2149052117.jpg"][id%2];
    }

    function filterCourses() {
        const filter = document.getElementById('searchInput').value.toLowerCase();
        const cards = document.getElementsByClassName('course-card'); 
        let hasVisible = false;
        for (let i = 0; i < cards.length; i++) {
            const title = cards[i].getAttribute('data-title').toLowerCase();
            if (title.includes(filter)) { cards[i].style.display = ""; hasVisible = true; } else { cards[i].style.display = "none"; }
        }
        document.getElementById('noResults').classList.toggle('hidden', hasVisible);
    }

    async function loadCourses() {
        try {
            const res = await fetch("/courses/");
            const courses = await res.json();
            let myCourseIds = [];
            try {
                const resEnroll = await fetch("/enrollments/");
                if(resEnroll.ok) {
                    const enrollments = await resEnroll.json();
                    myCourseIds = enrollments.filter(e => e.student_id === studentId).map(e => e.course_id);
                }
            } catch(e) {}

            const catalog = document.getElementById("catalog");
            catalog.innerHTML = "";
            if(!courses.length) { catalog.innerHTML = "<p>No courses.</p>"; return; }

            courses.forEach(c => {
                const isOwned = myCourseIds.includes(c.id);
                const imgSrc = getCourseImage(c.id);
                catalog.innerHTML += `
                    <div class="course-card bg-white rounded-xl shadow-md overflow-hidden card-hover transition-all duration-300 border border-gray-100 flex flex-col h-full" data-title="${c.title}">
                        <div class="h-40 overflow-hidden relative group"><img src="${imgSrc}" class="w-full h-full object-cover">
                            ${isOwned ? '<div class="absolute top-2 right-2 bg-green-500 text-white text-xs font-bold px-2 py-1 rounded shadow">OWNED</div>' : ''}
                        </div>
                        <div class="p-4 flex flex-col flex-grow"><h3 class="font-bold text-base text-gray-800 mb-1 line-clamp-1">${c.title}</h3>
                            <div class="flex items-center justify-between mt-auto pt-2">
                                ${isOwned ? `<button onclick="openPlayer(${c.id}, '${c.title}')" class="w-full bg-emerald-600 hover:bg-emerald-700 text-white font-bold py-2 px-4 rounded-lg text-sm">Play</button>` 
                                : `<button onclick="window.location.href='/checkout?course_id=${c.id}&price=${c.price}&title=${encodeURIComponent(c.title)}'" class="bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-2 px-4 text-sm rounded-lg">Enroll ₹${c.price}</button>`}
                            </div>
                        </div>
                    </div>`;
            });
        } catch(e) {}
    }

    async function openPlayer(id, title) {
        document.getElementById("learningArea").classList.remove("hidden");
        document.body.style.overflow = "hidden";
        document.getElementById("courseTitle").innerText = title;

        const res = await fetch(`/courses/${id}/learn?student_id=${studentId}`);
        courseData = await res.json();
        const playlist = document.getElementById("playlist");
        playlist.innerHTML = "";

        // Render Videos
        courseData.videos.forEach((v, index) => {
            const isDone = (courseData.progress.videos || "").split(",").includes(String(v.id));
            playlist.innerHTML += `
                <div onclick="playVideo('${v.url}', ${v.id}, ${id})" class="lesson-item p-3 rounded-lg hover:bg-indigo-50 cursor-pointer transition flex items-center gap-3 border-l-4 border-transparent hover:border-indigo-500 group bg-gray-50 mb-2">
                    <div class="w-8 h-8 rounded-full bg-white shadow-sm flex items-center justify-center text-gray-500"><i class="fa-solid fa-play text-xs"></i></div>
                    <div class="flex-grow"><p class="text-sm font-medium text-gray-700 line-clamp-1">${v.title}</p><p class="text-[10px] text-gray-400">Video</p></div>
                    ${isDone ? '<i class="fa-solid fa-circle-check text-green-500"></i>' : '<i class="fa-regular fa-circle text-gray-300"></i>'}
                </div>`;
        });

        // Render Resources
        if(courseData.resources && courseData.resources.length > 0) {
            playlist.innerHTML += `<div class="text-xs font-bold text-gray-400 uppercase mt-4 mb-2 pl-2">Study Materials</div>`;
            courseData.resources.forEach(r => {
                playlist.innerHTML += `
                    <a href="${r.url}" target="_blank" class="block p-3 rounded-lg hover:bg-orange-50 transition flex items-center gap-3 border-l-4 border-transparent hover:border-orange-500 bg-gray-50 mb-2">
                        <div class="w-8 h-8 rounded-full bg-white shadow-sm flex items-center justify-center text-orange-500"><i class="fa-solid fa-file-arrow-down text-xs"></i></div>
                        <div class="flex-grow"><p class="text-sm font-medium text-gray-700 line-clamp-1">${r.title}</p><p class="text-[10px] text-gray-400">Download/View</p></div>
                        <i class="fa-solid fa-arrow-up-right-from-square text-gray-300 text-xs"></i>
                    </a>`;
            });
        }

        // Render Quizzes
        if(courseData.quizzes.length > 0) {
            playlist.innerHTML += `<div class="text-xs font-bold text-gray-400 uppercase mt-4 mb-2 pl-2">Quizzes</div>`;
            courseData.quizzes.forEach((q, index) => {
                 const isDone = (courseData.progress.quizzes || "").split(",").includes(String(q.id));
                 playlist.innerHTML += `
                    <div onclick="renderQuiz(${q.id}, ${id})" class="lesson-item p-3 rounded-lg hover:bg-purple-50 cursor-pointer transition flex items-center gap-3 border-l-4 border-transparent hover:border-purple-500 group bg-gray-50 mb-2">
                        <div class="w-8 h-8 rounded-full bg-white shadow-sm flex items-center justify-center text-purple-500"><i class="fa-solid fa-question text-xs"></i></div>
                        <div class="flex-grow"><p class="text-sm font-medium text-gray-700 line-clamp-1">${q.title}</p></div>
                        ${isDone ? '<i class="fa-solid fa-circle-check text-green-500"></i>' : '<i class="fa-regular fa-circle text-gray-300"></i>'}
                    </div>`;
            });
        }
    }

    function closePlayer() {
        document.getElementById("learningArea").classList.add("hidden");
        document.body.style.overflow = "auto"; 
        document.getElementById("videoStage").innerHTML = `<div class="text-center p-6"><i class="fa-solid fa-play-circle text-5xl md:text-6xl text-white opacity-50 mb-4"></i><p class="text-gray-400 text-sm">Select content.</p></div>`;
    }

    function playVideo(url, vId, cId) {
        document.querySelectorAll('.lesson-item').forEach(i => i.classList.remove('bg-indigo-100', 'border-indigo-500'));
        
        let videoId = "";
        const match = url.match(/(?:https?:\/\/)?(?:www\.)?(?:youtube\.com\/(?:[^\/\n\s]+\/\S+\/|(?:v|e(?:mbed)?)\/|\S*?[?&]v=)|youtu\.be\/)([a-zA-Z0-9_-]{11})/);
        if(match) videoId = match[1];

        const embedUrl = videoId ? `https://www.youtube.com/embed/${videoId}?autoplay=1` : url;
        
        document.getElementById("videoStage").innerHTML = `<iframe src="${embedUrl}" class="w-full h-full" allow="autoplay; encrypted-media" allowfullscreen></iframe>`;
        fetch("/progress/mark", { method: "POST", headers: {"Content-Type":"application/json"}, body: JSON.stringify({student_id:studentId, course_id:cId, item_id:vId, type:"video"}) });
    }

    function renderQuiz(qId, cId) {
        const quiz = courseData.quizzes.find(q => q.id === qId);
        let html = `<div class="bg-white p-8 rounded-xl shadow-2xl max-w-2xl w-full m-4 overflow-y-auto max-h-full">
            <h2 class="text-2xl font-bold mb-6 border-b pb-2">${quiz.title}</h2>`;
        
        quiz.questions.forEach((q, i) => {
            html += `<div class="mb-6">
                <p class="font-bold text-lg mb-2">${i+1}. ${q.question}</p>
                <div class="space-y-2">
                    ${q.options.map(opt => `<label class="block p-3 border rounded hover:bg-gray-50 cursor-pointer"><input type="radio" name="q${q.id}" value="${opt}" class="mr-2"> ${opt}</label>`).join('')}
                </div>
            </div>`;
        });
        html += `<button onclick="submitQuiz(${qId}, ${cId})" class="w-full bg-indigo-600 text-white font-bold py-3 rounded-lg hover:bg-indigo-700">Submit Assessment</button></div>`;
        document.getElementById("videoStage").innerHTML = html;
    }

    function submitQuiz(qId, cId) {
        const quiz = courseData.quizzes.find(q => q.id === qId);
        let score = 0;
        quiz.questions.forEach(q => {
            const selected = document.querySelector(`input[name="q${q.id}"]:checked`);
            // ✅ IMPROVED CHECK: Trim both strings to ignore spaces
            if(selected && selected.value.trim() === q.answer.trim()) {
                score++;
            }
        });
        
        alert(`You scored ${score}/${quiz.questions.length}`);
        if(score === quiz.questions.length) {
            fetch("/progress/mark", { method: "POST", headers: {"Content-Type":"application/json"}, body: JSON.stringify({student_id:studentId, course_id:cId, item_id:qId, type:"quiz"}) });
        }
    }
    loadCourses();
</script>
</body>
</html>